#!/bin/bash

set -euo pipefail

FILE="_build/bin/dark.byte"

# Stop the server
(ps aux | pgrep 'ocamlrun' | xargs kill -9 > /dev/null 2>&1) || true

# if it hasn't been compiled yet, wait for it
for ((i=1;i<=100;i++));
do
  if [ ! -f "${FILE}" ]; then
    sleep 0.01
  fi
done

if [ -f "${FILE}" ]; then
    echo "Running server"
    #COHTTP_DEBUG=true ocamlserver/main.byte > ../logs/server.log 2>&1 &
    ocamlrun "${FILE}" > ../logs/server.log 2>&1 &
else
  echo "${FILE} doesn't exist"
  exit -1
fi
