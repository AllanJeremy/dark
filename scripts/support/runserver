#!/bin/bash

set -euo pipefail

# Stop the server
(ps aux | pgrep 'main.byte' | xargs kill > /dev/null 2>&1) || true

# if it hasn't been compiled yet, wait for it
for ((i=1;i<=100;i++));
do
  if [ ! -f "server/main.byte" ]; then
    sleep 0.01
  fi
done


if [ -f "server/main.byte" ]; then
    #COHTTP_DEBUG=true ocamlserver/main.byte > logs/server.log 2>&1 &
    OCAMLRUNPARAM=b server/main.byte > logs/server.log 2>&1 &
else
  echo "server/main.byte doesn't exist"
  exit -1
fi
