#!/usr/bin/env python3.6

import os
import fcntl
import sys
import datetime
import subprocess
import threading

def run(bash, color):
  class ThreadWorker(threading.Thread):
    def __init__(self, pipe):
      super(ThreadWorker, self).__init__()
      self.pipe = pipe
      self.setDaemon(True)

    def run(self):
      for line in iter(self.pipe.readline, ''):
        p(">>> " + line, color=color, end='')


  proc = subprocess.Popen(bash, stdin=None, stdout=subprocess.PIPE, stderr=subprocess.PIPE, bufsize=0, shell=True, encoding='utf-8')
  stdout_worker = ThreadWorker(proc.stdout)
  stderr_worker = ThreadWorker(proc.stderr)
  stdout_worker.start()
  stderr_worker.start()

  proc.wait()
  stdout_worker.join()
  stderr_worker.join()

  return proc.returncode == 0



def consolecode(color):
  return "\u001B[" + str(color) + "m"

FIRST, LAST, WHITE, RED = 31, 37, 0, 32
color = FIRST
def nextcolor():
  global color
  color = color + 1
  if color == LAST:
    color = FIRST
  return color

def p(s, end=None, color=WHITE):
  date = datetime.datetime.now().strftime("%H:%M:%S:%f")
  date = ""
  newline = ""
  if s[0] == "\n":
    s = s[1:]
    newline = "\n"
  print(newline + consolecode(color) + date + ": " + s, end=end)
  sys.stdout.flush()

def call(bash):
  color = nextcolor()
  p("$ " + bash, color=color)
  result = run(bash, color=color)
  p("X " + bash, color=color)
  return result

def ignore(filename, reason):
  if reason != "Updated":
    return True

  # substring
  ignores = [".git", "scripts/", "logs/", "appdata/"]
  ignores += ["client/elm-stuff", "static/elm.js"]
  ignores += ["server/" + i for i in ["setup.log",
                                      "setup.data",
                                      "_build",
                                      "_tags",
                                      "myocamlbuild.ml",
                                      "Makefile"]]
  for i in ignores:
    if i in filename:
      return True
  # ocaml build temporary
  if filename[-10:-8] == "/C":
    return True
  # emacs thing
  if "/.#" in filename:
    return True
  return False

def elm_package():
  return call("cd client && elm-package install --yes")

def elm_make():
  return call("cd client && elm-make Main.elm --debug --yes --output ../static/elm.js")

def ocaml_build():
  return call("cd server && jbuilder build")

def ocaml_test():
  return call("cd server && jbuilder runtest")

def reload_server():
  return call("scripts/support/runserver")

def reload_browser():
  # Sends a signal to another fswatch on your mac
  return call("touch .browser-trigger")

def main():
  p("Starting")
  s1 = elm_package()
  s2 = elm_make()
  s3 = ocaml_build ()
  if s3:
    ocaml_test()
    reload_server()
  if s3 or (s1 and s2):
    reload_browser()

  for f in sys.stdin:
    (f, reason) = f.strip().split(" ")
    if ignore(f, reason):
      continue

    p("\nDetected change (" + reason + "): " + f)

    # Server
    if "dark.bc" in f or "dark.exe" in f:
      # ignore the trigger, the compile methods call this direct
      pass

    # Frontend
    elif "elm-package.json" in f:
      elm_package() and \
        elm_make() and \
        reload_browser()
    elif ".elm" in f:
      elm_make() and \
        reload_browser()


    # Ocaml
    elif ".ml" in f or "jbuild" or "_tags" in f:
      ocaml_build() and \
        reload_server() and \
        reload_browser()
      ocaml_test()

    # Other
    else:
      p("unknown file: " + f, end="")

  p("Done")

main()
