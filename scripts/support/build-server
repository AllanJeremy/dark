#!/usr/bin/env python3.6

import sys
import subprocess
import threading

def run(bash):
  proc = subprocess.run(bash, shell=True)
  return proc.returncode == 0

def compile(files):
  run("scripts/support/compile " + " ".join(files))

def initial_compile():
  compile(["client/Main.elm", "server/main/dark.ml"])

def process_watchers():
  files = []

  for f in sys.stdin:
    if "***BATCHEND***" in f:
      compile(files)
      files = []
    else:
      f, _ = f.strip().split(" ")
      files.append(f)

def background_task(fn):
  threading.Thread(target=fn).start()

def main():
  background_task(initial_compile)
  process_watchers()

main()
