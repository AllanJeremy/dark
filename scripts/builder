#!/bin/bash

set -euo pipefail

echo "Building docker image"
docker build -t dark .
# Use to build image from clean start
#docker build --no-cache -t dark .

echo "Removing running containers"
c=$(docker ps -q)
if [[ ! -z "${c}" ]]; then
  docker rm -f "${c}";
fi

echo "watching for local changes"
scripts/support/reload-browser > logs/browser.log 2>&1 &

if [ ! -d ../conduit-frontend ]; then
  echo "pulling the conduit frontend"
  # cd ../conduit-frontend && git pull
  pushd .. && git clone git@github.com:darklang/conduit-frontend && popd
fi

echo "Run the build"
fswatch -m fsevents_monitor \
        --event-flag-separator=, \
        -r * \
        -x \
    | docker run \
             --rm \
             -i \
             --mount type=bind,src="$PWD",dst=/home/dark/app \
             --mount type=bind,src="$PWD/../conduit-frontend",dst=/home/dark/conduit-frontend \
             -v pgconf:/etc/postgresql \
             -v pglogs:/var/log/postgresql \
             -v pgdata:/var/lib/postgresql \
             -p 8000:8000 \
             -p 8001:8001 \
             --security-opt seccomp=scripts/support/chrome-seccomp.json \
             -w /home/dark/app \
             dark \
             scripts/support/build-server "$@"
